COMPLETE Thread TLDR: Inventory System + Project Architecture
CRITICAL: Project Architecture Rules
ğŸš¨ THE GOLDEN RULE: DUAL PANEL LAYOUT IS SACRED ğŸš¨
The app has TWO PANELS that must NEVER be violated:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BANNER (Green Man Tavern navigation)                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                      â”‚                              â”‚
â”‚   LEFT PANEL         â”‚      RIGHT PANEL             â”‚
â”‚   (Fixed)            â”‚      (Changes based on       â”‚
â”‚                      â”‚       navigation)            â”‚
â”‚   - Tavern Home      â”‚                              â”‚
â”‚   - Character Cards  â”‚   Current feature displays   â”‚
â”‚   - Chat Interface   â”‚   here (Inventory, Living    â”‚
â”‚                      â”‚   Web, Journal, Quests, etc) â”‚
â”‚                      â”‚                              â”‚
â”‚                      â”‚                              â”‚
â”‚   Never changes      â”‚   â† ALL NEW FEATURES GO HERE â”‚
â”‚   unless character   â”‚                              â”‚
â”‚   is selected        â”‚                              â”‚
â”‚                      â”‚                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
Navigation Architecture
File: lib/green_man_tavern_web/live/dual_panel_live.ex
How routing works:

User clicks banner menu (HyperArk, Living Web, Inventory, etc.)
URL changes: /living_web, /inventory, /journal, etc.
handle_params detects live_action atom (:living_web, :inventory, etc.)
Right panel switches content based on live_action
Left panel stays the same (unless character is selected for chat)

Template Pattern:
heex<!-- In dual_panel_live.html.heex -->

<!-- LEFT PANEL - Always the same -->
<div class="left-panel">
  <!-- Character cards, chat interface -->
</div>

<!-- RIGHT PANEL - Switches based on @right_panel_action -->
<div class="right-panel">
  <%= case @right_panel_action do %>
    <% :home -> %>
      <!-- Home content -->
    
    <% :living_web -> %>
      <!-- Living Web goes here -->
    
    <% :inventory -> %>
      <!-- Inventory goes here (what we just built) -->
    
    <% :journal -> %>
      <!-- Journal goes here -->
    
    <% :quests -> %>
      <!-- Quests go here -->
  <% end %>
</div>

Project Files You MUST Reference
1. Project Knowledge Base (In Claude Project)
These files are in /mnt/project/:
ESSENTIAL READING:

Green_Man_Tavern_-_Complete_Rebuild_Plan.md - Overall architecture
HyperCard_Window_Chrome_Specification.md - UI design system
DUAL_PANEL_STATE_ARCHITECTURE_md.md - How panels work
Green_Man_Tavern_-_Validation_Visual_Reference_Guide.md - Visual standards

When adding new features, ALWAYS:

Read DUAL_PANEL_STATE_ARCHITECTURE_md.md first
Check HyperCard_Window_Chrome_Specification.md for styling
Reference Complete_Rebuild_Plan.md for context

2. Files Created This Thread

LIVING_WEB_INVENTORY_INTEGRATION.md - Inventory â†” Living Web design
TROUBLESHOOTING_GUIDE.md - Common issues and solutions
add_processing_and_actions_tables.exs - Database migration


What We Built This Thread
1. Database Layer âœ…
Tables:

user_inventory_items - Core inventory storage
processing_batches - Track transformations (drying, fermenting)
inventory_actions - Log all user actions (harvest, consume, etc.)

Schemas: InventoryItem, ProcessingBatch, InventoryAction
Context: Full CRUD in lib/green_man_tavern/inventory.ex
2. Right Panel UI âœ…
Location: RIGHT PANEL ONLY when route is /inventory
Features:

Category tabs with counts (ğŸ“¦ All, ğŸƒ Food, ğŸ’§ Water, â™»ï¸ Waste, âš¡ Energy)
Grid layout (5 columns, 60% width)
Detail panel (40% width) for selected items
Inline dropdown form for adding items (NOT a modal)
Active processes display with progress bars

Styling: HyperCard aesthetic (greyscale, borders, mono font)
3. Event Handlers âœ…
All in dual_panel_live.ex (added around line 175):

select_inventory_category
select_inventory_item
show_inventory_add_form / hide_inventory_add_form
add_inventory_item
delete_inventory_item


Critical Architecture Patterns
Pattern 1: Adding a New Feature to Right Panel
Step 1: Define Route
elixir# In router.ex
live_session :require_authenticated_user do
  scope "/", GreenManTavernWeb do
    live "/my_feature", DualPanelLive, :my_feature  # â† New route
  end
end
Step 2: Add to Banner Menu
heex<!-- In banner_menu_component.ex -->
<.link navigate={~p"/my_feature"} class="menu-item">
  My Feature
</.link>
Step 3: Handle in handle_params
elixir# In dual_panel_live.ex
def handle_params(_params, _url, socket) do
  action = socket.assigns.live_action  # This will be :my_feature
  
  socket = case action do
    :my_feature ->
      # Load data needed for this feature
      socket
      |> assign(:my_feature_data, load_data())
      |> assign(:my_feature_state, %{})
    
    _ -> socket
  end
  
  socket
  |> assign(:right_panel_action, action)
  |> assign(:page_title, page_title(action))
  
  {:noreply, socket}
end
Step 4: Add to Template
heex<!-- In dual_panel_live.html.heex, right panel section -->
<%= case @right_panel_action do %>
  <% :my_feature -> %>
    <div class="h-full">
      <!-- Your feature UI here -->
      <!-- STAYS IN RIGHT PANEL -->
    </div>
<% end %>
Pattern 2: Initialize Assigns in Mount
ALWAYS initialize ALL assigns in mount/3:
elixirdef mount(_params, _session, socket) do
  socket = socket
  # ... existing assigns ...
  |> assign(:my_feature_items, [])
  |> assign(:my_feature_selected, nil)
  |> assign(:my_feature_show_form, false)
  
  {:ok, socket}
end
Why: Templates fail with KeyError if assign doesn't exist
Pattern 3: Event Handler Structure
elixir@impl true
def handle_event("my_event", params, socket) do
  # Process event
  # Update assigns
  # Return socket
  {:noreply, socket}
end
```

**MUST have:**
- `@impl true` decorator
- Exact 3 parameters
- Return `{:noreply, socket}` tuple

---

## **Living Web â†” Inventory Integration Design**

### **Core Concept**
- **Living Web** = Planning/Design phase (macro systems)
- **Inventory** = Operations phase (micro resources)
- Systems in Living Web produce/consume items tracked in Inventory

### **Data Relationships**
```
Living Web Node â†’ user_systems â†’ inventory_items
                                â†“
                              inventory_actions
                                â†“
                              processing_batches
```

### **Integration Points**
1. **Harvest:** Click node â†’ Create inventory items
2. **Use:** Consume items â†’ Update system stats
3. **Process:** Transform items â†’ Track in processing_batches
4. **Flows:** Item movements update Living Web edges

**Full design:** See `LIVING_WEB_INVENTORY_INTEGRATION.md`

---

## **Tech Stack & Key Libraries**

### **Core:**
- Phoenix LiveView 1.0
- Ecto (PostgreSQL)
- Tailwind CSS

### **Living Web:**
- XyFlow (React Flow wrapper for Phoenix)
- Rendered in RIGHT PANEL as React component

### **UI Aesthetic:**
- HyperCard-inspired (greyscale, borders, chunky)
- Dwarf Fortress symbol language for inventory (`Â§â‰ˆâ™ â—˜`)
- Mono font throughout

### **Current User System:**
- Authentication via `UserAuth`
- User ID available as `socket.assigns.current_user.id`
- User-specific data loaded in mount/handle_params

---

## **File Structure Reference**
```
lib/
â”œâ”€â”€ green_man_tavern/
â”‚   â”œâ”€â”€ inventory.ex              # Context (CRUD functions)
â”‚   â”œâ”€â”€ inventory/
â”‚   â”‚   â”œâ”€â”€ inventory_item.ex     # Schema
â”‚   â”‚   â”œâ”€â”€ processing_batch.ex   # Schema
â”‚   â”‚   â””â”€â”€ inventory_action.ex   # Schema
â”‚   â”œâ”€â”€ diagrams.ex               # Living Web context
â”‚   â”œâ”€â”€ systems.ex                # Systems library
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ green_man_tavern_web/
â”‚   â”œâ”€â”€ live/
â”‚   â”‚   â”œâ”€â”€ dual_panel_live.ex         # Main LiveView âš ï¸ KEY FILE
â”‚   â”‚   â””â”€â”€ dual_panel_live.html.heex  # Template âš ï¸ KEY FILE
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â””â”€â”€ banner_menu_component.ex   # Top navigation
â”‚   â””â”€â”€ router.ex                       # Routes
â”‚
â””â”€â”€ assets/
    â””â”€â”€ js/
        â””â”€â”€ nodeTypes/                  # XyFlow node components
```

---

## **What's NOT Built Yet (Priorities)**

### **Phase 2: Core Flows (NEXT)**

**A. Harvest Flow** (Highest Priority)
- Click Living Web node â†’ "Harvest" button
- Creates inventory items from system
- Logs action, updates stats
- Shows flow animation

**B. Processing Flow**
- Select items â†’ "Start Drying/Fermenting"
- Creates processing_batch
- Background job completes process
- Creates output items

**C. Recipe/Consumption Flow**
- "Use in Recipe" button
- Ingredient matching
- Consume items
- Log action

### **Phase 3: Intelligence**
- Opportunity detection (waste patterns, abundance)
- Loop closure suggestions
- Quest generation from inventory data

### **Phase 4: Advanced**
- Community features
- Mobile optimization
- Analytics dashboard

---

## **Common Pitfalls & Solutions**

### **âŒ MISTAKE: Creating Full-Page Features**
**Problem:** New feature takes over entire page, breaks dual panel

**Solution:** 
- ALWAYS build in right panel case statement
- Test that left panel still shows character cards
- Verify banner navigation still works

### **âŒ MISTAKE: Direct Database Access in Templates**
**Problem:** Calling `Repo.get()` in .heex files

**Solution:**
- Load ALL data in `handle_params` or `mount`
- Store in assigns
- Template only displays assigns

### **âŒ MISTAKE: Missing Event Handlers**
**Problem:** Button clicks do nothing, FunctionClauseError

**Solution:**
- Verify handler exists: `grep -n "handle_event.*event_name"`
- Add handler with `@impl true` and 3 params
- Restart server after adding handlers

### **âŒ MISTAKE: Forgetting to Initialize Assigns**
**Problem:** KeyError when accessing `@some_assign`

**Solution:**
- Initialize ALL assigns in `mount/3`
- Use `Map.get(assigns, :key, default)` as backup
- Check `handle_params` sets feature-specific assigns

### **âŒ MISTAKE: Cursor AI Context Overload**
**Problem:** Cursor says "completed" but nothing changed

**Solution:**
- Start new Cursor agent every 5-10 changes
- Verify changes with `grep` or manual file inspection
- See `TROUBLESHOOTING_GUIDE.md`

---

## **Cursor AI Best Practices**

### **Starting a New Feature**
1. âœ… Start fresh Cursor agent
2. âœ… Reference project files from `/mnt/project/`
3. âœ… Plan which files need changes
4. âœ… Make one change at a time
5. âœ… Verify each change with `grep` or file inspection

### **When Cursor Fails Silently**
1. Check file manually: `cat lib/path/to/file.ex`
2. Search for expected code: `grep -n "function_name" file.ex`
3. If missing, add manually or give Cursor very specific prompt
4. Reset agent and try again

### **Prompt Structure for Cursor**
```
CONTEXT: [What exists, what we're building]

TASK: [Specific single task]

INSTRUCTIONS:
1. [Exact file to open]
2. [Exact location to add code]
3. [Exact code to add - paste full function]
4. [Verification command]

VERIFICATION:
- [How to verify it worked]

Quick Reference Commands
bash# Start development
mix phx.server

# Check routes
mix phx.routes | grep inventory

# Check if handler exists
grep -n "def handle_event(\"event_name\"" lib/**/*.ex

# Check migration status
mix ecto.migrations

# Recompile everything
mix clean && mix compile

# Test in IEx
iex -S mix
alias GreenManTavern.{Repo, Inventory}
Inventory.list_inventory_items(1)

# Undo uncommitted changes
git checkout .

# View recent changes
git diff
```

---

## **Starting New Thread Checklist**

### **Provide to AI:**
1. âœ… This TLDR document
2. âœ… `LIVING_WEB_INVENTORY_INTEGRATION.md`
3. âœ… Project files from `/mnt/project/`:
   - `DUAL_PANEL_STATE_ARCHITECTURE_md.md`
   - `HyperCard_Window_Chrome_Specification.md`
   - `Green_Man_Tavern_-_Complete_Rebuild_Plan.md`
4. âœ… Current goal (e.g., "Build harvest flow")

### **Initial Message Template:**
```
I'm continuing work on Green Man Tavern, a Phoenix LiveView 
permaculture game/app with dual-panel architecture.

COMPLETED THIS SESSION:
- Inventory system foundation (database, UI, CRUD)
- Right panel displays inventory grid
- Can add/delete items manually

CURRENT GOAL:
[Build harvest flow / Build processing flow / etc.]

ARCHITECTURE REMINDER:
- Left panel = character cards + chat (never changes)
- Right panel = features (Living Web, Inventory, etc.)
- All new work goes in RIGHT PANEL ONLY

PROJECT FILES ATTACHED:
[Attach TLDR + integration docs + architecture docs]

Please read the architecture docs first, then help me with [goal].

Success Metrics So Far
âœ… Database schema complete and migrated
âœ… Basic CRUD operations working
âœ… UI displays correctly in RIGHT PANEL ONLY
âœ… Event handlers all functional
âœ… Can add/delete items manually
âœ… Category filtering works
âœ… Item detail panel works
âœ… Dual panel architecture preserved
âœ… HyperCard aesthetic maintained
Ready for: Phase 2 - Connecting to Living Web for real workflows!

Next Session Quick Start
bash# 1. Check current state
git status
git log --oneline -5

# 2. Start server
mix phx.server

# 3. Test current inventory
# Visit: http://localhost:4000/inventory
# Verify: Can add items, grid displays correctly

# 4. Verify dual panel still works
# Visit: http://localhost:4000/living_web
# Verify: Left panel unchanged, right panel shows Living Web

# 5. Ready to build next feature!

Most Important Reminders
ğŸš¨ NEVER break the dual panel layout
ğŸš¨ ALWAYS build in right panel case statement
ğŸš¨ ALWAYS reference /mnt/project/ architecture docs
ğŸš¨ ALWAYS initialize assigns in mount
ğŸš¨ ALWAYS verify Cursor changes with grep
ğŸš¨ ALWAYS start fresh Cursor agent periodically

Status: âœ… Phase 1 Complete
Next: Phase 2 - Harvest Flow
Context Window: ~140K used this thread
Git Status: All committed, ready for next phase
GREEN MAN TAVERN: INVENTORY FOUNDATION COMPLETE! ğŸ®ğŸŒ±
